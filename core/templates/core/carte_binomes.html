{% extends 'core/base.html' %}
{% load static %}

{% block title %}Carte des Bin√¥mes - ESA Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { 
        height: 80vh; 
        width: 70%;  /* 80% de largeur */
        float: left;  /* Align√© √† gauche */
        margin-right: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .filter-control {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-height: 550px;
        overflow-y: auto;
        max-width: 280px;  /* R√©duit un peu pour laisser place √† la sidebar */
    }
    
    .filter-control h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
        border-bottom: 3px solid #0066cc;
        padding-bottom: 8px;
    }
    
    .filter-item {
        margin: 8px 0;
        display: flex;
        align-items: center;
        padding: 5px;
        border-radius: 4px;
    }
    
    .filter-item:hover {
        background: #f0f0f0;
    }
    
    .filter-item input[type="checkbox"] {
        margin-right: 10px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }
    
    .filter-item label {
        cursor: pointer;
        display: flex;
        align-items: center;
        flex: 1;
        font-size: 13px;
    }
    
    .filter-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 1px solid #333;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    /* Boutons Tout afficher / Tout cacher */
    .filter-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }

    .filter-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-btn-show {
        background-color: #28a745;
        color: white;
    }

    .filter-btn-show:hover {
        background-color: #218838;
    }

    .filter-btn-hide {
        background-color: #dc3545;
        color: white;
    }

    .filter-btn-hide:hover {
        background-color: #c82333;
    }
    .info-popup {
        font-family: Arial, sans-serif;
        min-width: 200px;
    }
    
    .info-popup h4 {
        margin: 0 0 10px 0;
        color: #0066cc;
        font-size: 16px;
        border-bottom: 2px solid #0066cc;
        padding-bottom: 5px;
    }
    
    .info-popup p {
        margin: 6px 0;
        font-size: 13px;
    }

    .sidebar {
        position: relative;
        width: 29%;  /* 20% de largeur */
        height: 80vh;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow-y: auto;
        z-index: 1000;
        transition: transform 0.3s ease;
        /* transform: translateX(100%);  Cach√© par d√©faut */
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .sidebar-header h3 {
        margin: 0;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-content {
        padding: 20px;
    }
    
    .sidebar-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .sidebar-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .sidebar-section h4 {
        color: var(--primary-dark);
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sidebar-info {
        display: grid;
        gap: 10px;
    }
    
    .sidebar-info-item {
        display: flex;
        align-items: start;
        gap: 10px;
    }
    
    .sidebar-info-label {
        font-weight: 600;
        color: #666;
        min-width: 110px;
        font-size: 13px;
    }
    
    .sidebar-info-value {
        color: #333;
        font-size: 14px;
        flex: 1;
    }
    
    .arrondissement-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        color: white;
    }

    /* Boutons d'action dans la sidebar */
    .sidebar-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }

    .sidebar-btn {
        flex: 1;
        padding: 10px 5px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        color: white;
    }

    .sidebar-btn-primary {
        background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        color: white !important;
    }

    .sidebar-btn-primary:hover {
        background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
    }

    .sidebar-btn-success {
        color: white !important;
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    }

    .sidebar-btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .sidebar-btn-warning {
        color: white !important;
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #000;
    }

    .sidebar-btn-warning:hover {
        background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .sidebar-btn i {
        font-size: 14px;
    }

    /* Style pour le panneau d'itin√©raire */
    .leaflet-routing-container {
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-width: 300px;
    }

    .leaflet-routing-container h2 {
        font-size: 14px;
        margin: 0 0 10px 0;
    }

    .leaflet-routing-alt {
        padding: 8px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
    }

    .leaflet-routing-alt:hover {
        background: #e9ecef;
    }

    /* Bouton pour afficher/masquer l'itin√©raire */
    .route-toggle-btn {
        padding: 8px 12px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 10px;
        width: 100%;
        justify-content: center;
        transition: all 0.2s;
    }

    .route-toggle-btn:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
    }

    .route-toggle-btn.active {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .route-toggle-btn.active:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
    }

    /* Info de l'itin√©raire dans la sidebar */
    .route-info {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        margin-top: 15px;
        border-left: 4px solid #6366f1;
    }

    .route-info h5 {
        margin: 0 0 8px 0;
        font-size: 13px;
        color: #6366f1;
        font-weight: 600;
    }

    .route-info-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 12px;
    }

    .route-info-label {
        color: #666;
    }

    .route-info-value {
        font-weight: 600;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="bi bi-link-45deg"></i> Carte des bin√¥mes actifs
            <span class="badge bg-primary">{{ total_binomes }} bin√¥me(s)</span>
        </h2>
        <p class="text-muted" style="margin-bottom: 0;">
            Visualisation des paires √©l√®ves-b√©n√©voles avec filtrage par arrondissement
        </p>
        <p class="text-muted">
            <small style="display: flex; align-items: center; gap: 20px; margin-top: 8px;">
                <span style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #FF5252; border: 2px solid #000;"></span>
                    <strong>Ronds</strong> = √âl√®ves en attente
                </span>
                <spa style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: #FF5252; border: 2px solid #000;"></span>
                    <strong>Carr√©s</strong> = Candidats/b√©n√©voles disponibles
                </span>
            </small>
        </p>
    </div>
</div>

<div id="map"></div>

<!-- Sidebar pour afficher les d√©tails -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 id="sidebar-title"></h3>
    </div>
    <div class="sidebar-content" id="sidebar-content">
    <div style="padding: 40px 20px; text-align: center; color: #666;">
        <div style="font-size: 48px; margin-bottom: 20px;">üëÜ</div>
        <p style="font-size: 16px; line-height: 1.6;">
            <strong>Cliquez sur un marqueur</strong><br>
            pour afficher les informations d√©taill√©es de l'√©l√®ve ou du b√©n√©vole
        </p>
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
// ============================================================================
// üé® CONFIGURATION
// ============================================================================

// Variables globales pour le routing
let currentRoutingControl = null;
let currentRouteInfo = null;
let currentEleveCoords = null;
let currentBenevoleCoords = null;

const markerColors = [
    '#FF5252', '#18FFFF', '#B2FF59', '#FFD740', '#E040FB',
    '#FFFF00', '#69F0AE', '#FF6E40', '#FF4081', '#40C4FF',
    '#7C4DFF', '#FFD740', '#B2FF59', '#FFAB40', '#E040FB', '#1DE9B6'
];

const colors = [
    '#FF1744', '#00E5FF', '#76FF03', '#FF9100', '#E040FB',
    '#FFEA00', '#00E676', '#FF3D00', '#F50057', '#00B0FF',
    '#651FFF', '#FFC400', '#64DD17', '#FF6D00', '#D500F9', '#00BFA5'
];
function getCouleurArrondissement(codePostalOuArrondissement) {
    if (!codePostalOuArrondissement) return '#aaaaaa';
    
    const str = codePostalOuArrondissement.toString();
    const match = str.match(/130(\d{2})/);
    
    if (match) {
        const numero = parseInt(match[1], 10);
        if (numero >= 1 && numero <= 16) {
            return markerColors[numero - 1];
        }
    }
    
    return '#aaaaaa';
}

// ============================================================================
// üó∫Ô∏è INITIALISATION DE LA CARTE
// ============================================================================

const map = L.map('map').setView([43.2965, 5.3698], 12);
const initialMapView = { center: [43.2965, 5.3698], zoom: 12 };

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// ============================================================================
// üìä CHARGEMENT DES DONN√âES
// ============================================================================

let geojsonData = null;
let arrondissementLayers = [];
let binomeLayers = [];
const arrondissementVisibility = {};

// ‚≠ê 1. CHARGER LE GEOJSON DES ARRONDISSEMENTS
fetch('{% static "core/data/arrondissements.geojson" %}')
    .then(response => response.json())
    .then(geojson => {
        console.log('GeoJSON charg√©:', geojson.features.length, 'arrondissements');
        geojsonData = geojson;
        
        // Cr√©er les layers d'arrondissements
        geojson.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = colors[(arr - 1) % colors.length];
            
            const layer = L.geoJSON(feature, {
                style: {
                    color: '#333333',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.25
                }
            }).addTo(map);
            
            layer.bindPopup(`
                <div class="info-popup">
                    <h4>${nom}</h4>
                    <p><strong>Code postal:</strong> ${arr}</p>
                </div>
            `);
            
            arrondissementLayers.push({
                index: index,
                nom: nom,
                layer: layer,
                arrondissement: arr
            });
            
            arrondissementVisibility[index] = true;
        });
        
        // Cr√©er le contr√¥le de filtrage
        creerControleFiltre();
        
        // ‚≠ê 2. CHARGER LES BIN√îMES (apr√®s avoir les arrondissements)
        return fetch('{% url "core:api_binomes" %}');
    })
    .then(response => response.json())
    .then(data => {
        console.log(`${data.count} bin√¥mes charg√©s`);
        
        data.binomes.forEach(binome => {
            const eleve = binome.eleve;
            const benevole = binome.benevole;
            const date_debut = binome.date_debut;
            
            const eleveArrIndex = extraireNumeroArrondissementTexte(eleve.arrondissement);
            const couleurEleve = markerColors[(eleveArrIndex-1) % markerColors.length];
            
            // Trouver l'arrondissement du b√©n√©vole
            const benevoleArrIndex = extraireNumeroArrondissement(benevole.arrondissement);
            const couleurBenevole = markerColors[(benevoleArrIndex-1) % markerColors.length];
            
            // Ligne de connexion
            const polyline = L.polyline(
                [[eleve.latitude, eleve.longitude], [benevole.latitude, benevole.longitude]],
                {
                    color: '#000000',
                    weight: 2,
                    opacity: 0.9,
                    dashArray: '5, 5'
                }
            ).addTo(map);
            
            // Marqueur √©l√®ve
            const markerEleve = L.circleMarker([eleve.latitude, eleve.longitude], {
                radius: 8,
                fillColor: couleurEleve,
                color: '#000000',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9,
                pane: 'markerPane'
            }).addTo(map);
            
            // Marqueur √©l√®ve - Remplace le bindPopup par un click
            markerEleve.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click √©l√®ve:', eleve.prenom);  // ‚Üê Pour d√©boguer
                showSidebar(benevole, eleve, couleurBenevole, binome);
            });

            // Marqueur b√©n√©vole - CARR√â color√© (Candidat/Disponible)
            const squareIcon = L.divIcon({
                className: 'square-marker',
                html: `<div style="
                    width: 16px; 
                    height: 16px; 
                    background-color: ${couleurBenevole}; 
                    border: 2px solid #000000;
                    transform: translate(-8px, -8px);
                    opacity: 0.9;
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            // Marqueur b√©n√©vole
            const markerBenevole = L.marker([benevole.latitude, benevole.longitude], {
                icon: squareIcon,
                pane: 'markerPane'
            }).addTo(map);
            
             // Marqueur b√©n√©vole - Remplace le bindPopup par un click
            markerBenevole.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click b√©n√©vole:', benevole.prenom);  // ‚Üê Pour d√©boguer
                showSidebar(benevole, eleve, couleurBenevole, binome);
            });
            
            // Stocker le bin√¥me
            binomeLayers.push({
                eleveArrIndex: eleveArrIndex,
                benevoleArrIndex: benevoleArrIndex,
                polyline: polyline,
                markerEleve: markerEleve,
                markerBenevole: markerBenevole
            });
        });
        
        // Ajuster la vue
        if (data.binomes.length > 0) {
            const bounds = [];
            data.binomes.forEach(binome => {
                bounds.push([binome.eleve.latitude, binome.eleve.longitude]);
                bounds.push([binome.benevole.latitude, binome.benevole.longitude]);
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });

// ============================================================================
// üîç FONCTIONS UTILITAIRES
// ============================================================================

function extraireNumeroArrondissement(codePostal) {
    // codePostal = 13007 (string ou number)
    const str = codePostal.toString();  // "13007"
    const match = str.match(/130(\d{2})/);  // Cherche "130" suivi de 2 chiffres
    // match[1] = "07"
    
    if (match) {
        return parseInt(match[1], 10);  // Convertit "07" en 7
    }
    
    return 0;  // Si pas trouv√©
}

/**
 * Extrait le num√©ro d'arrondissement du format "1er", "2e", "3e"...
 * Utilis√© pour les √âL√àVES
 */
function extraireNumeroArrondissementTexte(arrondissementTexte) {
    if (!arrondissementTexte) return 0;
    
    const str = arrondissementTexte.toString();
    // Cherche un ou plusieurs chiffres au d√©but : "1er" -> "1", "16e" -> "16"
    const match = str.match(/^(\d+)/);
    
    if (match) {
        return parseInt(match[1], 10);
    }
    
    return 0;
}

function updateBinomeVisibility() {
    binomeLayers.forEach(binome => {
        const eleveVisible = arrondissementVisibility[binome.eleveArrIndex];
        const benevoleVisible = arrondissementVisibility[binome.benevoleArrIndex];
        const shouldShow = eleveVisible && benevoleVisible;
        
        if (shouldShow) {
            map.addLayer(binome.polyline);
            map.addLayer(binome.markerEleve);
            map.addLayer(binome.markerBenevole);
        } else {
            map.removeLayer(binome.polyline);
            map.removeLayer(binome.markerEleve);
            map.removeLayer(binome.markerBenevole);
        }
    });
}

// ============================================================================
// üéõÔ∏è CONTR√îLE DE FILTRAGE
// ============================================================================

function creerControleFiltre() {
    const filterControl = L.control({ position: 'topright' });
    
    filterControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'filter-control');
        
        div.innerHTML = `
            <h3>üîç Filtrer par arrondissement</h3>
            <div class="filter-buttons">
                <button class="filter-btn filter-btn-show" onclick="toggleTousArrondissements(true)">
                    Tout afficher
                </button>
                <button class="filter-btn filter-btn-hide" onclick="toggleTousArrondissements(false)">
                    Tout cacher
                </button>
            </div>
        `;
        geojsonData.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = markerColors[(arr - 1) % markerColors.length];
            
            div.innerHTML += `
                <div class="filter-item">
                    <input type="checkbox" id="arr${index}" checked onchange="toggleArrondissement(${index})">
                    <label for="arr${index}">
                        <span class="filter-color" style="background-color: ${color};"></span>
                        <span>${nom}</span>
                    </label>
                </div>
            `;
        });
        
        return div;
    };
    
    filterControl.addTo(map);
}

// Fonction globale pour toggle tous les arrondissements
window.toggleTousArrondissements = function(show) {
    geojsonData.features.forEach((feature, index) => {
        const checkbox = document.getElementById('arr' + index);
        if (checkbox) {
            checkbox.checked = show;
            arrondissementVisibility[index] = show;
        }
    });
    updateBinomeVisibility();
};

// Fonction globale pour toggle arrondissement
window.toggleArrondissement = function(index) {
    const checkbox = document.getElementById('arr' + index);
    arrondissementVisibility[index] = checkbox.checked;
    updateBinomeVisibility();
};

// ============================================================================
// üìã GESTION DE LA SIDEBAR
// ============================================================================

// ============================================================================
// GESTION DES ITIN√âRAIRES
// ============================================================================

/**
 * Affiche l'itin√©raire √† pied entre deux points
 */
function afficherItineraire(latLngEleve, latLngBenevole, mode = 'foot') {
    // Supprimer l'itin√©raire pr√©c√©dent s'il existe
    if (currentRoutingControl) {
        map.removeControl(currentRoutingControl);
        currentRoutingControl = null;
    }
    
    console.log('Calcul itin√©raire:', mode, 'de', latLngEleve, 'vers', latLngBenevole);
    
    // Cr√©er le contr√¥le de routing
    // OSRM v1 attend une URL sans le profil √† la fin
    currentRoutingControl = L.Routing.control({
        waypoints: [
            L.latLng(latLngEleve[0], latLngEleve[1]),
            L.latLng(latLngBenevole[0], latLngBenevole[1])
        ],
        router: L.Routing.osrmv1({
            // L'URL de base sans le profil - il sera ajout√© automatiquement
            serviceUrl: 'https://router.project-osrm.org/route/v1',
        }),
        routeWhileDragging: false,
        showAlternatives: false,
        addWaypoints: false,
        draggableWaypoints: false,
        lineOptions: {
            styles: [{color: '#6366f1', opacity: 0.8, weight: 6}]
        },
        createMarker: function() { return null; },
        fitSelectedRoutes: true,
        show: false,
        collapsible: false,
    }).addTo(map);
    
    // Cacher le panneau d'instructions s'il existe
    setTimeout(() => {
        const routingContainer = document.querySelector('.leaflet-routing-container');
        if (routingContainer) {
            routingContainer.style.display = 'none';
        }
    }, 100);

    // √âcouter l'√©v√©nement quand l'itin√©raire est trouv√©
    currentRoutingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const summary = routes[0].summary;
        
        console.log('‚úÖ Itin√©raire trouv√©!', summary);
        
        // Calculer la distance et le temps
        const distanceKm = (summary.totalDistance / 1000).toFixed(2);
        const tempsMinutes = Math.round(summary.totalTime / 60);
        
        // V√©rification : vitesse moyenne
        const vitesseMoyenne = (summary.totalDistance / 1000) / (summary.totalTime / 3600);
        console.log('Vitesse moyenne calcul√©e:', vitesseMoyenne.toFixed(2), 'km/h');
        
        // Si le temps semble trop court (vitesse > 10 km/h), recalculer manuellement
        let tempsAffiche = tempsMinutes;
        if (vitesseMoyenne > 10) {
            // Recalcul manuel avec vitesse pi√©ton r√©aliste (5 km/h)
            const distanceNum = parseFloat(distanceKm);
            tempsAffiche = Math.round((distanceNum / 5) * 60);
            console.log('‚ö†Ô∏è Recalcul manuel du temps:', tempsAffiche, 'min (vitesse 5 km/h)');
        }
        
        // Stocker les infos
        currentRouteInfo = {
            distance: distanceKm,
            temps: tempsAffiche,
            mode: '√Ä pied',
            vitesse: vitesseMoyenne.toFixed(1)
        };
        
        // Mettre √† jour l'affichage
        setTimeout(() => {
            const routeInfoDiv = document.getElementById('route-info');
            if (routeInfoDiv && currentRouteInfo) {
                routeInfoDiv.style.display = 'block';
                document.getElementById('route-distance').textContent = currentRouteInfo.distance + ' km';
                document.getElementById('route-time').textContent = currentRouteInfo.temps + ' min';
            }
        }, 500);
        
        console.log(`Itin√©raire trouv√©: ${distanceKm} km, ${tempsAffiche} min`);
    });
    
    // G√©rer les erreurs
    currentRoutingControl.on('routingerror', function(e) {
        console.error('‚ùå Erreur routing:', e);
        
        // Afficher l'erreur d√©taill√©e dans la console
        if (e.error && e.error.message) {
            console.error('Message d\'erreur:', e.error.message);
        }
        if (e.error && e.error.status) {
            console.error('Status HTTP:', e.error.status);
        }
        
        alert('Impossible de calculer l\'itin√©raire.\nErreur: ' + (e.error?.message || 'Inconnue'));
        masquerItineraire();
    });
}

/**
 * Masque l'itin√©raire
 */
function masquerItineraire() {
    if (currentRoutingControl) {
        map.removeControl(currentRoutingControl);
        currentRoutingControl = null;
        currentRouteInfo = null;
        
        // Revenir au zoom initial
        map.setView(initialMapView.center, initialMapView.zoom);
    }
}

/**
 * Toggle l'affichage de l'itin√©raire
 */
function toggleItineraire(latLngEleve, latLngBenevole, mode = 'foot') {
    if (currentRoutingControl) {
        masquerItineraire();
        return false;
    } else {
        afficherItineraire(latLngEleve, latLngBenevole, mode);
        return true;
    }
}

/**
 * Toggle l'itin√©raire (appel√© par les boutons)
 */
window.toggleRoute = function(mode) {
    if (!currentEleveCoords || !currentBenevoleCoords) {
        console.error('Coordonn√©es manquantes');
        alert('Erreur: coordonn√©es manquantes');
        return;
    }
    
    const btn = document.getElementById(`route-toggle-${mode}`);
    const text = document.getElementById(`route-text-${mode}`);
    const routeInfoDiv = document.getElementById('route-info');
    
    if (!btn || !text) {
        console.error('Bouton introuvable');
        return;
    }
    
    const isActive = toggleItineraire(currentEleveCoords, currentBenevoleCoords, mode);
    
    if (isActive) {
        btn.classList.add('active');
        text.textContent = 'Masquer l\'itin√©raire';
    } else {
        btn.classList.remove('active');
        text.textContent = 'Voir l\'itin√©raire √† pied';
        if (routeInfoDiv) {
            routeInfoDiv.style.display = 'none';
        }
    }
};

/**
 * Affiche la sidebar avec les d√©tails d'un bin√¥me
 */
function showSidebar(benevole, eleve, couleur, binome) {
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebar-title');
    const content = document.getElementById('sidebar-content');
    
    // Stocker les coordonn√©es pour l'itin√©raire
    currentEleveCoords = [eleve.latitude, eleve.longitude];
    currentBenevoleCoords = [benevole.latitude, benevole.longitude];
    
    // Masquer l'itin√©raire pr√©c√©dent
    masquerItineraire();
    
    title.innerHTML = `üéì Bin√¥me`;
    
    content.innerHTML = `
        <div class="sidebar-actions">
            <a href="/admin/core/eleve/${eleve.id}/change/" 
            class="sidebar-btn sidebar-btn-primary" 
            target="_blank">
                <i class="bi bi-person-badge"></i>
                <span>Editer √âl√®ve</span>
            </a>
            <a href="/admin/core/benevole/${benevole.id}/change/" 
            class="sidebar-btn sidebar-btn-success" 
            target="_blank">
                <i class="bi bi-mortarboard"></i>
                <span>Editer Mentor</span>
            </a>
            ${binome ? `
            <a href="/admin/core/binome/${binome.id}/change/" 
            class="sidebar-btn sidebar-btn-warning" 
            target="_blank">
                <i class="bi bi-people"></i>
                <span>Editer Bin√¥me</span>
            </a>
            ` : ''}
        </div>
        <div class="sidebar-section">
            <h4>üéì Mentor</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom complet</span>
                    <span class="sidebar-info-value"><strong>${benevole.prenom} ${benevole.nom}</strong></span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">T√©l√©phone</span>
                    <span class="sidebar-info-value">
                        ${benevole.telephone || 'Non renseign√©'}
                    </span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Adresse</span>
                    <span class="sidebar-info-value">
                        ${benevole.adresse || ''}<br>
                         <span class="arrondissement-badge" style="background-color: ${couleur};">
                            ${benevole.arrondissement}
                        </span>
                        ${benevole.ville || ''}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h4>üë®‚Äçüéì Mentor√©</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom</span>
                    <span class="sidebar-info-value">${eleve.prenom} ${eleve.nom}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Classe</span>
                    <span class="sidebar-info-value">${eleve.classe || 'Non renseign√©e'}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Adresse</span>
                    <span class="sidebar-info-value">
                        ${eleve.adresse || ''}<br>
                         <span class="arrondissement-badge" style="background-color: ${couleur};">
                            ${eleve.code_postal || eleve.arrondissement}
                        </span>
                        ${eleve.ville || ''}
                    </span>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">R√©f√©rent</span>
                    <span class="sidebar-info-value">${eleve.referent || 'Non renseign√©'}</span>
                </div>
                ${binome && binome.date_debut ? `
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Date de d√©but</span>
                    <span class="sidebar-info-value">
                        ${new Date(binome.date_debut).toLocaleDateString('fr-FR')}
                    </span>
                </div>
                ` : ''}
            </div>
            
            <!-- Bouton itin√©raire -->
            <button class="route-toggle-btn" id="route-toggle-foot" onclick="toggleRoute('foot')" style="margin-top: 15px;">
                <i class="bi bi-person-walking"></i>
                <span id="route-text-foot">Voir l'itin√©raire √† pied</span>
            </button>
            
            <!-- Info itin√©raire (cach√© par d√©faut) -->
            <div class="route-info" id="route-info" style="display: none;">
                <h5><i class="bi bi-map"></i> Itin√©raire √† pied</h5>
                <div class="route-info-item">
                    <span class="route-info-label">Distance:</span>
                    <span class="route-info-value" id="route-distance">-</span>
                </div>
                <div class="route-info-item">
                    <span class="route-info-label">Temps estim√©:</span>
                    <span class="route-info-value" id="route-time">-</span>
                </div>
            </div>
        </div>
    `;
}

// Fermer la sidebar en cliquant sur la carte
map.on('click', function(e) {
    // Masquer l'itin√©raire
    masquerItineraire();
    
    // Ne fermer que si on clique sur la carte, pas sur un marqueur
    if (e.originalEvent.target.classList.contains('leaflet-container') || 
        e.originalEvent.target.tagName === 'path') {
        // closeSidebar(); // Si vous avez une fonction closeSidebar
    }
});
</script>
{% endblock %}