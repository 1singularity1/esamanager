{% extends 'core/base.html' %}
{% load static %}

{% block title %}Carte des Bin√¥mes - ESA Manager{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { 
        height: 70vh; 
        width: 70%;  /* 80% de largeur */
        float: left;  /* Align√© √† gauche */
        margin-right: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .filter-control {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-height: 550px;
        overflow-y: auto;
        max-width: 280px;  /* R√©duit un peu pour laisser place √† la sidebar */
    }
    
    .filter-control h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
        border-bottom: 3px solid #0066cc;
        padding-bottom: 8px;
    }
    
    .filter-item {
        margin: 8px 0;
        display: flex;
        align-items: center;
        padding: 5px;
        border-radius: 4px;
    }
    
    .filter-item:hover {
        background: #f0f0f0;
    }
    
    .filter-item input[type="checkbox"] {
        margin-right: 10px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }
    
    .filter-item label {
        cursor: pointer;
        display: flex;
        align-items: center;
        flex: 1;
        font-size: 13px;
    }
    
    .filter-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 1px solid #333;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    .info-popup {
        font-family: Arial, sans-serif;
        min-width: 200px;
    }
    
    .info-popup h4 {
        margin: 0 0 10px 0;
        color: #0066cc;
        font-size: 16px;
        border-bottom: 2px solid #0066cc;
        padding-bottom: 5px;
    }
    
    .info-popup p {
        margin: 6px 0;
        font-size: 13px;
    }

    .sidebar {
        position: relative;
        width: 29%;  /* 20% de largeur */
        height: 70vh;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow-y: auto;
        z-index: 1000;
        transition: transform 0.3s ease;
        /* transform: translateX(100%);  Cach√© par d√©faut */
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 20px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .sidebar-header h3 {
        margin: 0;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-content {
        padding: 20px;
    }
    
    .sidebar-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .sidebar-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .sidebar-section h4 {
        color: #0066cc;
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sidebar-info {
        display: grid;
        gap: 10px;
    }
    
    .sidebar-info-item {
        display: flex;
        align-items: start;
        gap: 10px;
    }
    
    .sidebar-info-label {
        font-weight: 600;
        color: #666;
        min-width: 110px;
        font-size: 13px;
    }
    
    .sidebar-info-value {
        color: #333;
        font-size: 14px;
        flex: 1;
    }
    
    .arrondissement-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="bi bi-link-45deg"></i> Carte des bin√¥mes actifs
            <span class="badge bg-primary">{{ total_binomes }} bin√¥me(s)</span>
        </h2>
        <p class="text-muted">
            Visualisation des paires √©l√®ves-b√©n√©voles avec filtrage par arrondissement
        </p>
    </div>
</div>

<div id="map"></div>

<!-- Sidebar pour afficher les d√©tails -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 id="sidebar-title"></h3>
    </div>
    <div class="sidebar-content" id="sidebar-content">
    <div style="padding: 40px 20px; text-align: center; color: #666;">
        <div style="font-size: 48px; margin-bottom: 20px;">üëÜ</div>
        <p style="font-size: 16px; line-height: 1.6;">
            <strong>Cliquez sur un marqueur</strong><br>
            pour afficher les informations d√©taill√©es de l'√©l√®ve ou du b√©n√©vole
        </p>
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
// ============================================================================
// üé® CONFIGURATION
// ============================================================================

const markerColors = [
    '#FF5252', '#18FFFF', '#B2FF59', '#FFD740', '#E040FB',
    '#FFFF00', '#69F0AE', '#FF6E40', '#FF4081', '#40C4FF',
    '#7C4DFF', '#FFD740', '#B2FF59', '#FFAB40', '#E040FB', '#1DE9B6'
];

const colors = [
    '#FF1744', '#00E5FF', '#76FF03', '#FF9100', '#E040FB',
    '#FFEA00', '#00E676', '#FF3D00', '#F50057', '#00B0FF',
    '#651FFF', '#FFC400', '#64DD17', '#FF6D00', '#D500F9', '#00BFA5'
];
function getCouleurArrondissement(codePostalOuArrondissement) {
    if (!codePostalOuArrondissement) return '#aaaaaa';
    
    const str = codePostalOuArrondissement.toString();
    const match = str.match(/130(\d{2})/);
    
    if (match) {
        const numero = parseInt(match[1], 10);
        if (numero >= 1 && numero <= 16) {
            return markerColors[numero - 1];
        }
    }
    
    return '#aaaaaa';
}

// ============================================================================
// üó∫Ô∏è INITIALISATION DE LA CARTE
// ============================================================================

const map = L.map('map').setView([43.2965, 5.3698], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// ============================================================================
// üìä CHARGEMENT DES DONN√âES
// ============================================================================

let geojsonData = null;
let arrondissementLayers = [];
let binomeLayers = [];
const arrondissementVisibility = {};

// ‚≠ê 1. CHARGER LE GEOJSON DES ARRONDISSEMENTS
fetch('{% static "core/data/arrondissements.geojson" %}')
    .then(response => response.json())
    .then(geojson => {
        console.log('GeoJSON charg√©:', geojson.features.length, 'arrondissements');
        geojsonData = geojson;
        
        // Cr√©er les layers d'arrondissements
        geojson.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = colors[(arr - 1) % colors.length];
            
            const layer = L.geoJSON(feature, {
                style: {
                    color: '#333333',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.25
                }
            }).addTo(map);
            
            layer.bindPopup(`
                <div class="info-popup">
                    <h4>${nom}</h4>
                    <p><strong>Code postal:</strong> ${arr}</p>
                </div>
            `);
            
            arrondissementLayers.push({
                index: index,
                nom: nom,
                layer: layer,
                arrondissement: arr
            });
            
            arrondissementVisibility[index] = true;
        });
        
        // Cr√©er le contr√¥le de filtrage
        creerControleFiltre();
        
        // ‚≠ê 2. CHARGER LES BIN√îMES (apr√®s avoir les arrondissements)
        return fetch('{% url "core:api_binomes" %}');
    })
    .then(response => response.json())
    .then(data => {
        console.log(`${data.count} bin√¥mes charg√©s`);
        
        data.binomes.forEach(binome => {
            const eleve = binome.eleve;
            const benevole = binome.benevole;
            
            const eleveArrIndex = extraireNumeroArrondissementTexte(eleve.arrondissement);
            const couleurEleve = markerColors[(eleveArrIndex-1) % markerColors.length];
            
            // Trouver l'arrondissement du b√©n√©vole
            const benevoleArrIndex = extraireNumeroArrondissement(benevole.arrondissement);
            const couleurBenevole = markerColors[(benevoleArrIndex-1) % markerColors.length];
            
            // Ligne de connexion
            const polyline = L.polyline(
                [[eleve.latitude, eleve.longitude], [benevole.latitude, benevole.longitude]],
                {
                    color: '#000000',
                    weight: 2,
                    opacity: 0.9,
                    dashArray: '5, 5'
                }
            ).addTo(map);
            
            // Marqueur √©l√®ve
            const markerEleve = L.circleMarker([eleve.latitude, eleve.longitude], {
                radius: 8,
                fillColor: couleurEleve,
                color: '#000000',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9,
                pane: 'markerPane'
            }).addTo(map);
            
            // Marqueur √©l√®ve - Remplace le bindPopup par un click
            markerEleve.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click √©l√®ve:', eleve.prenom);  // ‚Üê Pour d√©boguer
                showSidebarEleve(eleve, benevole, couleurEleve);
            });

            // markerEleve.bindPopup(`
            //     <div class="info-popup">
            //         <h4>üë®‚Äçüéì ${eleve.prenom} ${eleve.nom}</h4>
            //         <p><strong>Classe:</strong> ${eleve.classe}</p>
            //         <p><strong>Code postal:</strong> ${eleve.arrondissement}</p>
            //         <p><strong>B√©n√©vole:</strong> ${benevole.prenom} ${benevole.nom}</p>
            //     </div>
            // `);
            
            // Marqueur b√©n√©vole - CARR√â color√© (Candidat/Disponible)
            const squareIcon = L.divIcon({
                className: 'square-marker',
                html: `<div style="
                    width: 16px; 
                    height: 16px; 
                    background-color: ${couleurBenevole}; 
                    border: 2px solid #000000;
                    transform: translate(-8px, -8px);
                    opacity: 0.9;
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            // Marqueur b√©n√©vole
            const markerBenevole = L.marker([benevole.latitude, benevole.longitude], {
                icon: squareIcon,
                pane: 'markerPane'
            }).addTo(map);
            
             // Marqueur b√©n√©vole - Remplace le bindPopup par un click
            markerBenevole.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click b√©n√©vole:', benevole.prenom);  // ‚Üê Pour d√©boguer
                showSidebarBenevole(benevole, eleve, couleurBenevole);
            });
            
            // markerBenevole.bindPopup(`
            //     <div class="info-popup">
            //         <h4>üéì ${benevole.prenom} ${benevole.nom}</h4>
            //         <p><strong>Code postal:</strong> ${benevole.arrondissement}</p>
            //         <p><strong>√âl√®ve:</strong> ${eleve.prenom} ${eleve.nom}</p>
            //     </div>
            // `);
            
            // Stocker le bin√¥me
            binomeLayers.push({
                eleveArrIndex: eleveArrIndex,
                benevoleArrIndex: benevoleArrIndex,
                polyline: polyline,
                markerEleve: markerEleve,
                markerBenevole: markerBenevole
            });
        });
        
        // Ajuster la vue
        if (data.binomes.length > 0) {
            const bounds = [];
            data.binomes.forEach(binome => {
                bounds.push([binome.eleve.latitude, binome.eleve.longitude]);
                bounds.push([binome.benevole.latitude, binome.benevole.longitude]);
            });
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });

// ============================================================================
// üîç FONCTIONS UTILITAIRES
// ============================================================================

function extraireNumeroArrondissement(codePostal) {
    // codePostal = 13007 (string ou number)
    const str = codePostal.toString();  // "13007"
    const match = str.match(/130(\d{2})/);  // Cherche "130" suivi de 2 chiffres
    // match[1] = "07"
    
    if (match) {
        return parseInt(match[1], 10);  // Convertit "07" en 7
    }
    
    return 0;  // Si pas trouv√©
}

/**
 * Extrait le num√©ro d'arrondissement du format "1er", "2e", "3e"...
 * Utilis√© pour les √âL√àVES
 */
function extraireNumeroArrondissementTexte(arrondissementTexte) {
    if (!arrondissementTexte) return 0;
    
    const str = arrondissementTexte.toString();
    // Cherche un ou plusieurs chiffres au d√©but : "1er" -> "1", "16e" -> "16"
    const match = str.match(/^(\d+)/);
    
    if (match) {
        return parseInt(match[1], 10);
    }
    
    return 0;
}

function updateBinomeVisibility() {
    binomeLayers.forEach(binome => {
        const eleveVisible = arrondissementVisibility[binome.eleveArrIndex];
        const benevoleVisible = arrondissementVisibility[binome.benevoleArrIndex];
        const shouldShow = eleveVisible && benevoleVisible;
        
        if (shouldShow) {
            map.addLayer(binome.polyline);
            map.addLayer(binome.markerEleve);
            map.addLayer(binome.markerBenevole);
        } else {
            map.removeLayer(binome.polyline);
            map.removeLayer(binome.markerEleve);
            map.removeLayer(binome.markerBenevole);
        }
    });
}

// ============================================================================
// üéõÔ∏è CONTR√îLE DE FILTRAGE
// ============================================================================

function creerControleFiltre() {
    const filterControl = L.control({ position: 'topright' });
    
    filterControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'filter-control');
        div.innerHTML = '<h3>üîç Filtrer par arrondissement</h3>';
        
        geojsonData.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = markerColors[(arr - 1) % markerColors.length];
            
            div.innerHTML += `
                <div class="filter-item">
                    <input type="checkbox" id="arr${index}" checked onchange="toggleArrondissement(${index})">
                    <label for="arr${index}">
                        <span class="filter-color" style="background-color: ${color};"></span>
                        <span>${nom}</span>
                    </label>
                </div>
            `;
        });
        
        return div;
    };
    
    filterControl.addTo(map);
}

// Fonction globale pour toggle arrondissement
window.toggleArrondissement = function(index) {
    const checkbox = document.getElementById('arr' + index);
    arrondissementVisibility[index] = checkbox.checked;
    updateBinomeVisibility();
};

// ============================================================================
// üìã GESTION DE LA SIDEBAR
// ============================================================================

/**
 * Affiche la sidebar avec les d√©tails d'un √©l√®ve
 */
function showSidebarEleve(eleve, benevole, couleur) {
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebar-title');
    const content = document.getElementById('sidebar-content');
    
    title.innerHTML = `üë®‚Äçüéì √âl√®ve`;
    
    content.innerHTML = `
        <div class="sidebar-section">
            <h4>üë§ Informations personnelles</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom complet</span>
                    <span class="sidebar-info-value"><strong>${eleve.prenom} ${eleve.nom}</strong></span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Classe</span>
                    <span class="sidebar-info-value">${eleve.classe || 'Non renseign√©e'}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Arrondissement</span>
                    <span class="sidebar-info-value">
                        <span class="arrondissement-badge" style="background-color: ${couleur};">
                            ${eleve.arrondissement}
                        </span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h4>üéì B√©n√©vole associ√©</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom</span>
                    <span class="sidebar-info-value">${benevole.prenom} ${benevole.nom}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Code postal</span>
                    <span class="sidebar-info-value">${benevole.code_postal}</span>
                </div>
            </div>
        </div>
    `;
}

/**
 * Affiche la sidebar avec les d√©tails d'un b√©n√©vole
 */
function showSidebarBenevole(benevole, eleve, couleur) {
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebar-title');
    const content = document.getElementById('sidebar-content');
    
    title.innerHTML = `üéì B√©n√©vole`;
    
    content.innerHTML = `
        <div class="sidebar-section">
            <h4>üë§ Informations personnelles</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom complet</span>
                    <span class="sidebar-info-value"><strong>${benevole.prenom} ${benevole.nom}</strong></span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Code postal</span>
                    <span class="sidebar-info-value">
                        <span class="arrondissement-badge" style="background-color: ${couleur};">
                            ${benevole.code_postal}
                        </span>
                    </span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h4>üë®‚Äçüéì √âl√®ve accompagn√©</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom</span>
                    <span class="sidebar-info-value">${eleve.prenom} ${eleve.nom}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Classe</span>
                    <span class="sidebar-info-value">${eleve.classe || 'Non renseign√©e'}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Arrondissement</span>
                    <span class="sidebar-info-value">${eleve.arrondissement}</span>
                </div>
            </div>
        </div>
    `;
}

// Fermer la sidebar en cliquant sur la carte
map.on('click', function(e) {
    // Ne fermer que si on clique sur la carte, pas sur un marqueur
    if (e.originalEvent.target.classList.contains('leaflet-container') || 
        e.originalEvent.target.tagName === 'path') {
        closeSidebar();
    }
});
</script>
{% endblock %}