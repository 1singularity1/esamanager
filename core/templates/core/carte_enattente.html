{% extends 'core/base.html' %}
{% load static %}

{% block title %}Carte des √©l√®ves en attente & des b√©n√©voles candidat - ESA Manager{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { 
        height: 80vh; 
        width: 70%;  /* 80% de largeur */
        float: left;  /* Align√© √† gauche */
        margin-right: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .filter-control {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-height: 550px;
        overflow-y: auto;
        max-width: 280px;  /* R√©duit un peu pour laisser place √† la sidebar */
    }
    
    .filter-control h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
        border-bottom: 3px solid #0066cc;
        padding-bottom: 8px;
    }
    
    .filter-item {
        margin: 8px 0;
        display: flex;
        align-items: center;
        padding: 5px;
        border-radius: 4px;
    }
    
    .filter-item:hover {
        background: #f0f0f0;
    }
    
    .filter-item input[type="checkbox"] {
        margin-right: 10px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }
    
    .filter-item label {
        cursor: pointer;
        display: flex;
        align-items: center;
        flex: 1;
        font-size: 13px;
    }
    
    .filter-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 1px solid #333;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    /* Boutons Tout afficher / Tout cacher */
    .filter-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }

    .filter-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-btn-show {
        background-color: #28a745;
        color: white;
    }

    .filter-btn-show:hover {
        background-color: #218838;
    }

    .filter-btn-hide {
        background-color: #dc3545;
        color: white;
    }

    .filter-btn-hide:hover {
        background-color: #c82333;
    }
    
    .info-popup {
        font-family: Arial, sans-serif;
        min-width: 200px;
    }
    
    .info-popup h4 {
        margin: 0 0 10px 0;
        color: #0066cc;
        font-size: 16px;
        border-bottom: 2px solid #0066cc;
        padding-bottom: 5px;
    }
    
    .info-popup p {
        margin: 6px 0;
        font-size: 13px;
    }

    .sidebar {
        position: relative;
        width: 29%;  /* 20% de largeur */
        height: 80vh;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        overflow-y: auto;
        z-index: 1000;
        transition: transform 0.3s ease;
        /* transform: translateX(100%);  Cach√© par d√©faut */
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .sidebar-header h3 {
        margin: 0;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-content {
        padding: 20px;
    }
    
    .sidebar-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .sidebar-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .sidebar-section h4 {
        color: var(--primary-dark);
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sidebar-info {
        display: grid;
        gap: 10px;
    }
    
    .sidebar-info-item {
        display: flex;
        align-items: start;
        gap: 10px;
    }
    
    .sidebar-info-label {
        font-weight: 600;
        color: #666;
        min-width: 110px;
        font-size: 13px;
    }
    
    .sidebar-info-value {
        color: #333;
        font-size: 14px;
        flex: 1;
    }
    
    .arrondissement-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        color: white;
    }
    
    /* Style pour les marqueurs carr√©s des b√©n√©voles */
    .square-marker {
        background: transparent !important;
        border: none !important;
    }

    /* Boutons d'action dans la sidebar */
    .sidebar-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }

    .sidebar-btn {
        flex: 1;
        padding: 10px 5px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        color: white;
    }

    .sidebar-btn-primary {
        background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
        color: white !important;
    }

    .sidebar-btn-primary:hover {
        background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
    }

    .sidebar-btn-success {
        color: white !important;
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    }

    .sidebar-btn-success:hover {
        background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .sidebar-btn-warning {
        color: white !important;
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #000;
    }

    .sidebar-btn-warning:hover {
        background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .sidebar-btn i {
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="bi bi-geo-alt"></i> Carte des √©l√®ves en attente & des b√©n√©voles disponibles
            <span class="badge bg-primary">{{ total_eleves }} √âl√®ve(s) en attente</span>
            <span class="badge bg-primary">{{ total_candidats }} B√©n√©vole(s) disponible(s)</span>
        </h2>
        <p class="text-muted">
            Visualisation g√©ographique des √©l√®ves en attente et des b√©n√©voles candidats/disponibles
            <small style="display: flex; align-items: center; gap: 20px; margin-top: 8px;">
                <span style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #FF5252; border: 2px solid #000;"></span>
                    <strong>Ronds</strong> = √âl√®ves en attente
                </span>
                <spa style="display: flex; align-items: center; gap: 6px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: #FF5252; border: 2px solid #000;"></span>
                    <strong>Carr√©s</strong> = Candidats/b√©n√©voles disponibles
                </span>
            </small>
        </p>
    </div>
</div>

<div id="map"></div>

<!-- Sidebar pour afficher les d√©tails -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h3 id="sidebar-title"></h3>
    </div>
    <div class="sidebar-content" id="sidebar-content">
    <div style="padding: 40px 20px; text-align: center; color: #666;">
        <div style="font-size: 48px; margin-bottom: 20px;">üëÜ</div>
        <p style="font-size: 16px; line-height: 1.6;">
            <strong>Cliquez sur un marqueur</strong><br>
            pour afficher les informations d√©taill√©es de l'√©l√®ve ou du b√©n√©vole
        </p>
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
// ============================================================================
// üé® CONFIGURATION
// ============================================================================
// L√âGENDE DES MARQUEURS :
// - √âL√àVES EN ATTENTE : Ronds color√©s (circleMarker)
// - B√âN√âVOLES CANDIDAT/DISPONIBLE : Carr√©s color√©s (divIcon)
// Les couleurs correspondent aux arrondissements de Marseille (13001-13016)
// ============================================================================

let elevesData = [];
let benevolesData = [];

const markerColors = [
    '#FF5252', '#18FFFF', '#B2FF59', '#FFD740', '#E040FB',
    '#FFFF00', '#69F0AE', '#FF6E40', '#FF4081', '#40C4FF',
    '#7C4DFF', '#FFD740', '#B2FF59', '#FFAB40', '#E040FB', '#1DE9B6'
];

const colors = [
    '#FF1744', '#00E5FF', '#76FF03', '#FF9100', '#E040FB',
    '#FFEA00', '#00E676', '#FF3D00', '#F50057', '#00B0FF',
    '#651FFF', '#FFC400', '#64DD17', '#FF6D00', '#D500F9', '#00BFA5'
];
function getCouleurArrondissement(codePostalOuArrondissement) {
    if (!codePostalOuArrondissement) return '#aaaaaa';
    
    const str = codePostalOuArrondissement.toString();
    const match = str.match(/130(\d{2})/);
    
    if (match) {
        const numero = parseInt(match[1], 10);
        if (numero >= 1 && numero <= 16) {
            return markerColors[numero - 1];
        }
    }
    
    return '#aaaaaa';
}

// ============================================================================
// üó∫Ô∏è INITIALISATION DE LA CARTE
// ============================================================================

const map = L.map('map').setView([43.2965, 5.3698], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// ============================================================================
// üìä CHARGEMENT DES DONN√âES
// ============================================================================

let geojsonData = null;
let arrondissementLayers = [];
let binomeLayers = [];
const arrondissementVisibility = {};

// ‚≠ê 1. CHARGER LE GEOJSON DES ARRONDISSEMENTS
fetch('{% static "core/data/arrondissements.geojson" %}')
    .then(response => response.json())
    .then(geojson => {
        console.log('GeoJSON charg√©:', geojson.features.length, 'arrondissements');
        geojsonData = geojson;
        
        // Cr√©er les layers d'arrondissements
        geojson.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = colors[(arr - 1) % colors.length];
            
            const layer = L.geoJSON(feature, {
                style: {
                    color: '#333333',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.25
                }
            }).addTo(map);
            
            layer.bindPopup(`
                <div class="info-popup">
                    <h4>${nom}</h4>
                    <p><strong>Code postal:</strong> ${arr}</p>
                </div>
            `);
            
            arrondissementLayers.push({
                index: index,
                nom: nom,
                layer: layer,
                arrondissement: arr
            });
            
            arrondissementVisibility[index] = true;
        });
        
        // Cr√©er le contr√¥le de filtrage
        creerControleFiltre();
        
        // ‚≠ê 2. charger les candidats et les √©l√®ves √† accompagner (apr√®s avoir les arrondissements)
        return fetch('{% url "core:api_eleves" %}');
    })
    .then(response => response.json())
    .then(data => {
        elevesData= data; // Stocker dans la variable globale
        console.log(`${data.length} √©l√®ves charg√©s`);
        
        data.forEach(eleve => {
            const eleveArrIndex = extraireNumeroArrondissementTexte(eleve.arrondissement);
            const couleurEleve = markerColors[(eleveArrIndex-1) % markerColors.length];
            
            // Marqueur √©l√®ve - ROND color√© (en attente)
            const markerEleve = L.circleMarker([eleve.latitude, eleve.longitude], {
                radius: 8,
                fillColor: couleurEleve,
                color: '#000000',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9,
                pane: 'markerPane'
            }).addTo(map);
            
            // Marqueur √©l√®ve - Remplace le bindPopup par un click
            markerEleve.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click √©l√®ve:', eleve.prenom);  // ‚Üê Pour d√©boguer
                showSidebar(eleve, null, couleurEleve);
            });
        });
        
        // ‚≠ê 3. charger les b√©n√©voles candidats (apr√®s avoir les √©l√®ves)
        return fetch('{% url "core:api_benevoles" %}');
    })
    .then(response => response.json())
    .then(data => {
        benevolesData = data;  // Stocker dans la variable globale
        console.log(`${data.length} b√©n√©voles charg√©s`);
        
        data.forEach(benevole => {
            const benevoleArrIndex = extraireNumeroArrondissement(benevole.arrondissement);
            const couleurBenevole = markerColors[(benevoleArrIndex-1) % markerColors.length];
            
            // Marqueur b√©n√©vole - CARR√â color√© (Candidat/Disponible)
            const squareIcon = L.divIcon({
                className: 'square-marker',
                html: `<div style="
                    width: 16px; 
                    height: 16px; 
                    background-color: ${couleurBenevole}; 
                    border: 2px solid #000000;
                    transform: translate(-8px, -8px);
                    opacity: 0.9;
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const markerBenevole = L.marker([benevole.latitude, benevole.longitude], {
                icon: squareIcon,
                pane: 'markerPane'
            }).addTo(map);
            
             // Marqueur b√©n√©vole - Remplace le bindPopup par un click
            markerBenevole.on('click', function(e) {
                L.DomEvent.stopPropagation(e);  // ‚Üê Ajoute cette ligne
                console.log('Click b√©n√©vole:', benevole.prenom);  // ‚Üê Pour d√©boguer
                showSidebar(null, benevole, couleurBenevole);
            });
            
        });
    })
    .catch(error => {
        console.error('Erreur:', error);
    });

// ============================================================================
// üîç FONCTIONS UTILITAIRES
// ============================================================================

// ============================================================================
// üîç FONCTION : CALCULER LA DISTANCE ENTRE DEUX POINTS (Haversine)
// ============================================================================
function calculerDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Rayon de la Terre en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distance en km
}

// ============================================================================
// üö∂ FONCTION : CALCULER LA DUR√âE √Ä PIED (vitesse moyenne 5 km/h)
// ============================================================================
function calculerDuree(distanceKm) {
    const vitesseMoyenne = 5; // km/h √† pied
    const dureeHeures = distanceKm / vitesseMoyenne;
    const dureeMinutes = Math.round(dureeHeures * 60);
    
    if (dureeMinutes < 60) {
        return `${dureeMinutes} min`;
    } else {
        const heures = Math.floor(dureeMinutes / 60);
        const minutes = dureeMinutes % 60;
        return `${heures}h${minutes > 0 ? minutes.toString().padStart(2, '0') : ''}`;
    }
}

// ============================================================================
// üéØ FONCTION : TROUVER LES 3 PLUS PROCHES
// ============================================================================
function trouverPlusProches(pointReference, autresPoints, nombre = 3) {
    // Calculer la distance pour chaque point
    const avecDistances = autresPoints.map(point => ({
        ...point,
        distance: calculerDistance(
            pointReference.latitude, 
            pointReference.longitude,
            point.latitude, 
            point.longitude
        )
    }));
    
    // Trier par distance croissante et prendre les N premiers
    return avecDistances
        .sort((a, b) => a.distance - b.distance)
        .slice(0, nombre);
}

// ============================================================================
// üó∫Ô∏è FONCTION : AFFICHER L'ITIN√âRAIRE R√âEL SUR LA CARTE (OPENROUTESERVICE)
// VERSION PRODUCTION avec OpenRouteService
// ============================================================================

let itineraireActuel = null;
let markersItineraire = [];

// ‚ö†Ô∏è IMPORTANT : Remplacez par votre vraie cl√© API OpenRouteService
const OPENROUTE_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjY3NWViMmE0MGQ4MDQ1YTQ5MjlhNjQzNGU4NGUxZDFkIiwiaCI6Im11cm11cjY0In0=';

// ============================================================================
// üó∫Ô∏è FONCTION : AFFICHER L'ITIN√âRAIRE (OPENROUTESERVICE + D√âCODAGE POLYLINE)
// ============================================================================

// Fonction pour d√©coder le polyline (format Google/OpenRouteService)
function decodePolyline(str, precision) {
    precision = precision || 5;
    var index = 0,
        lat = 0,
        lng = 0,
        coordinates = [],
        shift = 0,
        result = 0,
        byte = null,
        latitude_change,
        longitude_change,
        factor = Math.pow(10, precision);

    while (index < str.length) {
        byte = null;
        shift = 0;
        result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        shift = result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        lat += latitude_change;
        lng += longitude_change;

        coordinates.push([lat / factor, lng / factor]);
    }

    return coordinates;
}

async function afficherItineraire(latDepart, lonDepart, latArrivee, lonArrivee) {
    // Supprimer l'itin√©raire pr√©c√©dent
    if (itineraireActuel) {
        map.removeLayer(itineraireActuel);
    }
    
    // Supprimer les anciens markers A et B
    markersItineraire.forEach(marker => map.removeLayer(marker));
    markersItineraire = [];
    
    // Message de chargement
    const loadingMsg = L.popup()
        .setLatLng([(latDepart + latArrivee) / 2, (lonDepart + lonArrivee) / 2])
        .setContent('<div style="text-align:center;"><i class="bi bi-hourglass-split"></i> Calcul de l\'itin√©raire √† pied...</div>')
        .openOn(map);
    
    try {
        const url = 'https://api.openrouteservice.org/v2/directions/foot-walking';
        
        const requestBody = {
            coordinates: [
                [lonDepart, latDepart],
                [lonArrivee, latArrivee]
            ]
        };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': OPENROUTE_API_KEY,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        map.closePopup(loadingMsg);
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('Erreur OpenRouteService:', errorData);
            alert('‚ùå Impossible de calculer l\'itin√©raire.');
            return;
        }
        
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            
            // ‚ö†Ô∏è IMPORTANT : D√©coder la g√©om√©trie polyline
            const encodedPolyline = route.geometry;
            const decodedCoordinates = decodePolyline(encodedPolyline, 5);
            
            // Les coordonn√©es sont d√©j√† au format [lat, lon] apr√®s d√©codage
            const coordinates = decodedCoordinates;
            
            console.log('‚úÖ Coordonn√©es d√©cod√©es:', coordinates.length, 'points');
            
            // Tracer l'itin√©raire
            itineraireActuel = L.polyline(coordinates, {
                color: '#0066cc',
                weight: 5,
                opacity: 0.7,
                dashArray: '10, 10',
                lineJoin: 'round'
            }).addTo(map);
            
            // Marqueur A (d√©part)
            const markerA = L.marker([latDepart, lonDepart], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background-color:#28a745;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);'><span style='color:white;font-weight:bold;font-size:18px;'>A</span></div>",
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('Point de d√©part');
            
            // Marqueur B (arriv√©e)
            const markerB = L.marker([latArrivee, lonArrivee], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background-color:#dc3545;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);'><span style='color:white;font-weight:bold;font-size:18px;'>B</span></div>",
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('Point d\'arriv√©e');
            
            markersItineraire = [markerA, markerB];
            
            // Zoomer sur l'itin√©raire
            map.fitBounds(itineraireActuel.getBounds(), { padding: [50, 50] });
            
            // Calculer distance et dur√©e
            const summary = route.summary;
            const distanceKm = (summary.distance / 1000).toFixed(2);
            const dureeMin = Math.round(summary.duration / 60);
            
            const dureeFormatted = dureeMin < 60 
                ? `${dureeMin} min` 
                : `${Math.floor(dureeMin / 60)}h${dureeMin % 60 > 0 ? (dureeMin % 60).toString().padStart(2, '0') : ''}`;
            
            // Popup avec les infos
            L.popup()
                .setLatLng([(latDepart + latArrivee) / 2, (lonDepart + lonArrivee) / 2])
                .setContent(`
                    <div style="text-align:center; font-family:Arial;">
                        <h5 style="margin:0 0 10px 0; color:#0066cc;">
                            <i class="bi bi-person-walking"></i> Itin√©raire √† pied
                        </h5>
                        <p style="margin:5px 0;">
                            <strong><i class="bi bi-geo"></i> Distance r√©elle:</strong> ${distanceKm} km
                        </p>
                        <p style="margin:5px 0;">
                            <strong><i class="bi bi-clock"></i> Dur√©e estim√©e:</strong> ${dureeFormatted}
                        </p>
                        <p style="margin:5px 0; font-size:11px; color:#666;">
                            (environ 5 km/h)
                        </p>
                    </div>
                `)
                .openOn(map);
            
            console.log(`‚úÖ Itin√©raire: ${distanceKm} km, ${dureeFormatted}`);
            
        } else {
            alert('‚ùå Aucun itin√©raire trouv√©');
        }
        
    } catch (error) {
        map.closePopup(loadingMsg);
        console.error('Erreur:', error);
        alert('‚ùå Erreur: ' + error.message);
    }
}


// ============================================================================
// üîç FONCTION : AFFICHER LES PERSONNES √Ä PROXIMIT√â (DISTANCE √Ä VOL D'OISEAU)
// Version simple et rapide - pas besoin d'API pour √ßa
// ============================================================================

function afficherProximite(type, id) {
    // R√©cup√©rer la personne de r√©f√©rence
    let personneRef, autresPersonnes, labelAutres, couleurs;
    
    if (type === 'eleve') {
        personneRef = elevesData.find(e => e.id === id);
        autresPersonnes = benevolesData.filter(b => b.latitude && b.longitude);
        labelAutres = 'B√©n√©voles';
        couleurs = ['#28a745', '#17a2b8', '#ffc107'];
    } else {
        personneRef = benevolesData.find(b => b.id === id);
        autresPersonnes = elevesData.filter(e => e.latitude && e.longitude);
        labelAutres = '√âl√®ves';
        couleurs = ['#dc3545', '#fd7e14', '#6f42c1'];
    }
    
    if (!personneRef || !personneRef.latitude || !personneRef.longitude) {
        document.getElementById(`proximite-results-${id}`).innerHTML = `
            <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; font-size: 14px;">
                <i class="bi bi-exclamation-triangle"></i> 
                Coordonn√©es GPS manquantes.
            </div>
        `;
        return;
    }
    
    if (autresPersonnes.length === 0) {
        document.getElementById(`proximite-results-${id}`).innerHTML = `
            <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; font-size: 14px;">
                <i class="bi bi-exclamation-triangle"></i> 
                Aucun${type === 'eleve' ? ' b√©n√©vole candidat' : ' √©l√®ve en attente'} g√©olocalis√© disponible.
            </div>
        `;
        return;
    }
    
    // Calculer les distances √† vol d'oiseau pour chaque personne
    const personnesAvecDistances = autresPersonnes.map(personne => {
        const distance = calculerDistance(
            personneRef.latitude, 
            personneRef.longitude, 
            personne.latitude, 
            personne.longitude
        );
        
        return {
            ...personne,
            distance: distance,
            duree: Math.round((distance / 5) * 60) // Dur√©e estim√©e √† 5 km/h
        };
    });
    
    // Trier par distance et prendre les 3 premiers
    const plusProches = personnesAvecDistances
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 3);
    
    // M√©dailles
    const medailles = ['ü•á', 'ü•à', 'ü•â'];
    
    // G√©n√©rer le HTML
    let html = `
        <div class="proximite-section" style="
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        ">
            <h5 style="
                margin: 0 0 15px 0; 
                color: #2c3e50;
                font-size: 16px;
                border-bottom: 3px solid #667eea;
                padding-bottom: 8px;
            ">
                <i class="bi bi-people-fill"></i> ${labelAutres} √† proximit√©
                <span style="
                    float: right;
                    background: #667eea;
                    color: white;
                    padding: 2px 8px;
                    border-radius: 20px;
                    font-size: 13px;
                ">${plusProches.length}</span>
            </h5>
    `;
    
    plusProches.forEach((personne, index) => {
        const distance = personne.distance.toFixed(2);
        const duree = personne.duree < 60 
            ? `${personne.duree} min` 
            : `${Math.floor(personne.duree / 60)}h${personne.duree % 60 > 0 ? (personne.duree % 60).toString().padStart(2, '0') : ''}`;
        
        html += `
            <div class="personne-card" style="
                background: white;
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 10px;
                border-left: 5px solid ${couleurs[index]};
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                transition: transform 0.3s, box-shadow 0.3s;
                position: relative;
            "
            onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.15)'"
            onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.1)'"
            >
                <!-- M√©daille -->
                <div style="
                    position: absolute;
                    top: -8px;
                    right: 8px;
                    background: white;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                ">
                    ${medailles[index]}
                </div>
                
                <!-- Infos personne -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="flex: 1; padding-right: 10px;">
                        <div style="font-weight: bold; font-size: 14px; color: #2c3e50; margin-bottom: 3px;">
                            ${personne.prenom} ${personne.nom}
                        </div>
                        <div style="font-size: 12px; color: #7f8c8d;">
                            <i class="bi bi-geo-alt-fill"></i> ${personne.arrondissement || personne.code_postal || 'Non d√©fini'}
                        </div>
                        ${personne.classe ? `
                            <div style="font-size: 12px; color: #7f8c8d;">
                                <i class="bi bi-book"></i> ${personne.classe}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Distance -->
                    <div style="text-align: right; min-width: 70px;">
                        <div style="
                            font-weight: bold; 
                            font-size: 16px; 
                            color: ${couleurs[index]};
                            margin-bottom: 2px;
                        ">
                            ‚âà ${distance} km
                        </div>
                        <div style="
                            color: #7f8c8d; 
                            font-size: 12px;
                            background: #ecf0f1;
                            padding: 3px 6px;
                            border-radius: 5px;
                        ">
                            <i class="bi bi-clock-fill"></i> ${duree}
                        </div>
                    </div>
                </div>
                
                <!-- Bouton itin√©raire -->
                <button 
                    onclick="afficherItineraire(
                        ${personneRef.latitude}, 
                        ${personneRef.longitude}, 
                        ${personne.latitude}, 
                        ${personne.longitude}
                    )"
                    style="
                        width: 100%;
                        padding: 8px;
                        background: ${couleurs[index]};
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        transition: all 0.3s;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    "
                    onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.3)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.2)'"
                >
                    <i class="bi bi-signpost-2-fill"></i> Afficher l'itin√©raire r√©el
                </button>
            </div>
        `;
    });
    
    html += `
            <div style="
                margin-top: 15px;
                padding: 10px;
                background: #e7f3ff;
                border-radius: 6px;
                font-size: 12px;
                color: #666;
                text-align: center;
            ">
                <i class="bi bi-info-circle"></i> 
                Distances √† vol d'oiseau (‚âà). Cliquez sur "Afficher l'itin√©raire" pour voir la distance r√©elle via les rues.
            </div>
        </div>
    `;
    
    // Afficher les r√©sultats
    document.getElementById(`proximite-results-${id}`).innerHTML = html;
}

// ============================================================================
// üé® FONCTION : G√âN√âRER LE HTML POUR LA SIDEBAR
// ============================================================================
function genererHTMLProximite(personneReference, plusProches, type) {
    // type = 'eleve' ou 'benevole'
    
    let html = `
        <div class="proximite-section" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h5 style="margin-bottom: 15px; color: #0066cc;">
                <i class="bi bi-geo-alt-fill"></i> 
                ${type === 'eleve' ? 'B√©n√©voles' : '√âl√®ves'} √† proximit√©
            </h5>
    `;
    
    plusProches.forEach((personne, index) => {
        const distance = personne.distance.toFixed(2);
        const duree = calculerDuree(personne.distance);
        
        html += `
            <div class="proximite-item" style="
                background: white; 
                padding: 12px; 
                margin-bottom: 10px; 
                border-radius: 6px;
                border-left: 4px solid ${index === 0 ? '#28a745' : index === 1 ? '#ffc107' : '#dc3545'};
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <strong style="font-size: 15px;">${personne.prenom} ${personne.nom}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 3px;">
                            ${personne.arrondissement || 'Arrondissement non d√©fini'}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 13px;">
                        <div style="font-weight: bold; color: #0066cc;">
                            <i class="bi bi-geo"></i> ${distance} km
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            <i class="bi bi-clock"></i> ${duree}
                        </div>
                    </div>
                </div>
                
                <button 
                    onclick="afficherItineraire(
                        ${personneReference.latitude}, 
                        ${personneReference.longitude}, 
                        ${personne.latitude}, 
                        ${personne.longitude}
                    )"
                    style="
                        width: 100%;
                        padding: 8px;
                        background: #0066cc;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 13px;
                        font-weight: 600;
                        transition: background 0.3s;
                    "
                    onmouseover="this.style.background='#0052a3'"
                    onmouseout="this.style.background='#0066cc'"
                >
                    <i class="bi bi-signpost-2"></i> Afficher l'itin√©raire
                </button>
            </div>
        `;
    });
    
    html += `</div>`;
    
    return html;
}

function extraireNumeroArrondissement(codePostal) {
    // codePostal = 13007 (string ou number)
    const str = codePostal.toString();  // "13007"
    const match = str.match(/130(\d{2})/);  // Cherche "130" suivi de 2 chiffres
    // match[1] = "07"
    
    if (match) {
        return parseInt(match[1], 10);  // Convertit "07" en 7
    }
    
    return 0;  // Si pas trouv√©
}

/**
 * Extrait le num√©ro d'arrondissement du format "1er", "2e", "3e"...
 * Utilis√© pour les √âL√àVES
 */
function extraireNumeroArrondissementTexte(arrondissementTexte) {
    if (!arrondissementTexte) return 0;
    
    const str = arrondissementTexte.toString();
    // Cherche un ou plusieurs chiffres au d√©but : "1er" -> "1", "16e" -> "16"
    const match = str.match(/^(\d+)/);
    
    if (match) {
        return parseInt(match[1], 10);
    }
    
    return 0;
}

function updateBinomeVisibility() {
    binomeLayers.forEach(binome => {
        const eleveVisible = arrondissementVisibility[binome.eleveArrIndex];
        const benevoleVisible = arrondissementVisibility[binome.benevoleArrIndex];
        const shouldShow = eleveVisible && benevoleVisible;
        
        if (shouldShow) {
            map.addLayer(binome.markerEleve);
            map.addLayer(binome.markerBenevole);
        } else {
            map.removeLayer(binome.markerEleve);
            map.removeLayer(binome.markerBenevole);
        }
    });
}

// ============================================================================
// üéõÔ∏è CONTR√îLE DE FILTRAGE
// ============================================================================

function creerControleFiltre() {
    const filterControl = L.control({ position: 'topright' });
    
    filterControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'filter-control');
        div.innerHTML = `
            <h3>üîç Filtrer par arrondissement</h3>
            <div class="filter-buttons">
                <button class="filter-btn filter-btn-show" onclick="toggleTousArrondissements(true)">
                    Tout afficher
                </button>
                <button class="filter-btn filter-btn-hide" onclick="toggleTousArrondissements(false)">
                    Tout cacher
                </button>
            </div>
        `;
        
        geojsonData.features.forEach((feature, index) => {
            const nom = feature.properties.nom;
            const arr = extraireNumeroArrondissement(feature.properties.codes_postaux);
            const color = markerColors[(arr - 1) % markerColors.length];
            
            div.innerHTML += `
                <div class="filter-item">
                    <input type="checkbox" id="arr${index}" checked onchange="toggleArrondissement(${index})">
                    <label for="arr${index}">
                        <span class="filter-color" style="background-color: ${color};"></span>
                        <span>${nom}</span>
                    </label>
                </div>
            `;
        });
        
        return div;
    };
    
    filterControl.addTo(map);
}

// Fonction globale pour toggle tous les arrondissements
window.toggleTousArrondissements = function(show) {
    geojsonData.features.forEach((feature, index) => {
        const checkbox = document.getElementById('arr' + index);
        if (checkbox) {
            checkbox.checked = show;
            arrondissementVisibility[index] = show;
        }
    });
    updateBinomeVisibility();
};

// Fonction globale pour toggle arrondissement
window.toggleArrondissement = function(index) {
    const checkbox = document.getElementById('arr' + index);
    arrondissementVisibility[index] = checkbox.checked;
    updateBinomeVisibility();
};

// ============================================================================
// üìã GESTION DE LA SIDEBAR
// ============================================================================

/**
 * Affiche la sidebar avec les d√©tails d'un √©l√®ve ou b√©n√©vole
 */
function showSidebar(eleve, benevole, couleur) {
    const sidebar = document.getElementById('sidebar');
    const title = document.getElementById('sidebar-title');
    const content = document.getElementById('sidebar-content');
    
    const prenom = eleve ? eleve.prenom : benevole.prenom;
    const nom = eleve ? eleve.nom : benevole.nom;
    const classe = eleve ? eleve.classe : '';
    const adresse = eleve ? eleve.adresse : benevole.adresse; 
    const codePostal = eleve ? eleve.code_postal : benevole.code_postal; 
    const ville = eleve ? eleve.ville : benevole.ville;
    const matieres = eleve ? eleve.matieres_souhaitees : benevole.matieres;
    const id = eleve ? eleve.id : benevole.id;
    const type = eleve ? 'eleve' : 'benevole';
    const url = eleve ? `/admin/core/eleve/${eleve.id}/change/` : `/admin/core/benevole/${benevole.id}/change/`;

    title.innerHTML = eleve ? `√âl√®ve en attente` : `B√©n√©vole candidat`;
    
    content.innerHTML = `
        <div class="sidebar-actions">
            <a href="${url}" 
            class="sidebar-btn sidebar-btn-primary" 
            target="_blank">
                <i class="bi bi-person-badge"></i>
                <span>√âditer ${eleve ? '√©l√®ve' : 'b√©n√©vole'}</span>
            </a>
        </div>
        <div class="sidebar-section">
            <h4><i class="bi bi-info-circle"></i> Informations personnelles</h4>
            <div class="sidebar-info">
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Nom</span>
                    <span class="sidebar-info-value">${prenom} ${nom}</span>
                </div>
                ${classe ? `
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Classe</span>
                    <span class="sidebar-info-value">${classe}</span>
                </div>
                ` : ''}
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Mati√®res</span>
                    <span class="sidebar-info-value">${matieres || 'Non d√©fini'}</span>
                </div>
                <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Adresse</span>
                    <span class="sidebar-info-value">
                        ${adresse || ''}<br>
                         <span class="arrondissement-badge" style="background-color: ${couleur};">
                            ${codePostal}
                        </span>
                        ${ville}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="sidebar-section" style="border-bottom: none;">
            <!-- Bouton pour trouver les personnes proches -->
            <button 
                id="btn-proximite-${id}"
                onclick="afficherProximite('${type}', ${id})"
                style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 15px;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s;
                    margin-bottom: 15px;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'"
            >
                <i class="bi bi-search"></i> Trouver ${eleve ? 'b√©n√©voles' : '√©l√®ves'} √† proximit√©
            </button>
            
            <!-- Zone pour afficher les r√©sultats de proximit√© -->
            <div id="proximite-results-${id}"></div>
        </div>
    `;
}

// Fermer la sidebar en cliquant sur la carte
map.on('click', function(e) {
    // Ne fermer que si on clique sur la carte, pas sur un marqueur
    if (e.originalEvent.target.classList.contains('leaflet-container') || 
        e.originalEvent.target.tagName === 'path') {
        closeSidebar();
    }
});
</script>
{% endblock %}