<!-- üíæ Template admin personnalis√© avec autosave - VERSION FINALE CORRIG√âE -->

{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}

<style>
    #autosave-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        z-index: 9999;
        font-size: 14px;
    }
    #autosave-status.saving {
        background: #FF9800;
    }
    #autosave-status.error {
        background: #F44336;
    }
</style>

<script>
(function() {
    console.log('üöÄ Script autosave charg√©');
    
    // Configuration
    const AUTOSAVE_INTERVAL = 30000; // 30 secondes
    
    let autosaveTimer = null;
    let isDirty = false;
    let eleveId = null;
    let CSRF_TOKEN = null;
    
    // R√©cup√©rer l'ID de l'√©l√®ve depuis l'URL
    const urlParts = window.location.pathname.split('/');
    const changeIndex = urlParts.indexOf('change');
    if (changeIndex > 0 && urlParts[changeIndex - 1]) {
        eleveId = urlParts[changeIndex - 1];
        console.log('üìã ID √©l√®ve trouv√©:', eleveId);
    } else {
        console.log('üìã Nouvel √©l√®ve (pas d\'ID)');
    }
    
    // Fonction pour afficher le statut
    function showStatus(message, type = 'success') {
        console.log('üí¨ Status:', message, '(type:', type + ')');
        
        let statusDiv = document.getElementById('autosave-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'autosave-status';
            document.body.appendChild(statusDiv);
        }
        
        statusDiv.textContent = message;
        statusDiv.className = type;
        statusDiv.style.display = 'block';
        
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // Fonction pour collecter les donn√©es du formulaire
    function getFormData() {
        const data = {
            id: eleveId,
            nom: document.getElementById('id_nom')?.value || '',
            prenom: document.getElementById('id_prenom')?.value || '',
            telephone: document.getElementById('id_telephone')?.value || '',
            nom_parent: document.getElementById('id_nom_parent')?.value || '',
            prenom_parent: document.getElementById('id_prenom_parent')?.value || '',
            telephone_parent: document.getElementById('id_telephone_parent')?.value || '',
            classe: document.getElementById('id_classe')?.value || '',
            etablissement: document.getElementById('id_etablissement')?.value || '',
            ville: document.getElementById('id_ville')?.value || '',
            code_postal: document.getElementById('id_code_postal')?.value || '',
            numero_rue: document.getElementById('id_numero_rue')?.value || '',
            adresse: document.getElementById('id_adresse')?.value || '',
            arrondissement: document.getElementById('id_arrondissement')?.value || '',
            latitude: document.getElementById('id_latitude')?.value || '',
            longitude: document.getElementById('id_longitude')?.value || '',
            statut: document.getElementById('id_statut')?.value || 'a_accompagner',
            informations_complementaires: document.getElementById('id_informations_complementaires')?.value || '',
        };
        
        console.log('üì¶ Donn√©es collect√©es:', data);
        return data;
    }
    
    // Fonction de sauvegarde automatique
    async function autosave() {
        console.log('üíæ Tentative de sauvegarde...');
        console.log('   - isDirty:', isDirty);
        console.log('   - CSRF_TOKEN:', CSRF_TOKEN ? 'pr√©sent' : 'MANQUANT');
        
        if (!isDirty) {
            console.log('‚è≠Ô∏è  Pas de modifications, pas de sauvegarde');
            return;
        }
        
        if (!CSRF_TOKEN) {
            console.error('‚ùå Token CSRF non disponible');
            return;
        }
        
        showStatus('Sauvegarde en cours...', 'saving');
        
        const data = getFormData();
        
        try {
            // ‚ö†Ô∏è URL CORRIG√âE : /autosave/eleve/ au lieu de /admin/autosave/eleve/
            console.log('üì§ Envoi de la requ√™te POST vers /autosave/eleve/');
            
            const response = await fetch('/autosave/eleve/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN,
                },
                body: JSON.stringify(data),
            });
            
            console.log('üì• R√©ponse re√ßue, status:', response.status);
            
            const result = await response.json();
            console.log('üìã R√©sultat:', result);
            
            if (result.success) {
                // Si c'√©tait une nouvelle cr√©ation, mettre √† jour l'ID
                if (!eleveId && result.id) {
                    eleveId = result.id;
                    console.log('üÜî Nouvel ID attribu√©:', eleveId);
                    
                    // Mettre √† jour l'URL sans recharger la page
                    const newUrl = window.location.pathname.replace('/add/', `/${result.id}/change/`);
                    window.history.replaceState({}, '', newUrl);
                    console.log('üîó URL mise √† jour:', newUrl);
                }
                
                const now = new Date().toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                showStatus(`‚úì Brouillon sauvegard√© √† ${now}`, 'success');
                isDirty = false;
                console.log('‚úÖ Sauvegarde r√©ussie !');
            } else {
                console.error('‚ùå Erreur de sauvegarde:', result.error);
                showStatus('‚úó Erreur de sauvegarde: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('‚ùå Erreur autosave:', error);
            showStatus('‚úó Erreur de connexion', 'error');
        }
    }
    
    // Marquer le formulaire comme modifi√©
    function markDirty(event) {
        console.log('‚úèÔ∏è  Formulaire modifi√© par:', event?.target?.id || event?.target?.name || 'inconnu');
        isDirty = true;
    }
    
    // D√©marrer l'autosave
    function startAutosave() {
        console.log('‚è∞ D√©marrage de l\'autosave...');
        
        // Sauvegarder imm√©diatement
        console.log('‚è±Ô∏è  Premi√®re sauvegarde programm√©e dans 2 secondes');
        setTimeout(autosave, 2000);
        
        // Puis toutes les 30 secondes
        autosaveTimer = setInterval(autosave, AUTOSAVE_INTERVAL);
        
        console.log('‚úÖ Autosave activ√© (toutes les 30 secondes)');
    }
    
    // Arr√™ter l'autosave
    function stopAutosave() {
        if (autosaveTimer) {
            clearInterval(autosaveTimer);
            console.log('üõë Autosave d√©sactiv√©');
        }
    }
    
    // Attacher les listeners √† un champ
    function attachListeners(field) {
        if (!field) return;
        
        ['input', 'change', 'keyup', 'blur'].forEach(eventType => {
            field.addEventListener(eventType, markDirty);
        });
        
        console.log('   ‚úì Listeners attach√©s √†:', field.id || field.name);
    }
    
    // Intercepter le submit normal pour marquer comme "complet"
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM charg√©, initialisation...');
        
        // R√©cup√©rer le token CSRF
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            CSRF_TOKEN = csrfInput.value;
            console.log('‚úÖ Token CSRF r√©cup√©r√©');
        } else {
            console.error('‚ùå Token CSRF introuvable dans le formulaire');
            showStatus('‚úó Erreur: Token CSRF manquant', 'error');
            return;
        }
        
        // Attacher les listeners √† TOUS les champs individuellement
        console.log('üëÇ Attachement des listeners aux champs...');
        
        const fieldIds = [
            'id_nom', 'id_prenom', 'id_telephone',
            'id_nom_parent', 'id_prenom_parent', 'id_telephone_parent',
            'id_classe', 'id_etablissement', 'id_ville', 'id_code_postal',
            'id_numero_rue', 'id_adresse', 'id_arrondissement',
            'id_latitude', 'id_longitude', 'id_statut',
            'id_informations_complementaires'
        ];
        
        let fieldsFound = 0;
        fieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                attachListeners(field);
                fieldsFound++;
            }
        });
        
        console.log(`‚úÖ ${fieldsFound} champs trouv√©s sur ${fieldIds.length}`);
        
        // Aussi √©couter TOUS les inputs, textareas et selects du formulaire
        const form = document.querySelector('form');
        if (form) {
            console.log('üìã Formulaire trouv√©, ajout de listeners globaux...');
            
            const allInputs = form.querySelectorAll('input, textarea, select');
            console.log(`   Found ${allInputs.length} input elements`);
            
            allInputs.forEach(input => {
                // √âviter les champs cach√©s et les boutons
                if (input.type !== 'hidden' && input.type !== 'submit' && input.type !== 'button') {
                    ['input', 'change', 'keyup'].forEach(eventType => {
                        input.addEventListener(eventType, markDirty);
                    });
                }
            });
            
            console.log('‚úÖ Listeners globaux attach√©s');
            
            // Intercepter la soumission du formulaire
            form.addEventListener('submit', async function(e) {
                console.log('üì§ Soumission du formulaire');
                
                if (eleveId) {
                    try {
                        // ‚ö†Ô∏è URL CORRIG√âE : /validate/eleve/ au lieu de /admin/validate/eleve/
                        await fetch('/validate/eleve/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF_TOKEN,
                            },
                            body: JSON.stringify({ id: eleveId }),
                        });
                        console.log('‚úÖ Validation envoy√©e');
                    } catch (error) {
                        console.error('‚ùå Erreur validation:', error);
                    }
                }
            });
        } else {
            console.error('‚ùå Formulaire non trouv√© !');
        }
        
        // D√©marrer l'autosave
        startAutosave();
        
        // Arr√™ter l'autosave quand on quitte la page
        window.addEventListener('beforeunload', function() {
            console.log('üëã Page en cours de fermeture');
            stopAutosave();
            if (isDirty) {
                console.log('üíæ Derni√®re sauvegarde avant fermeture');
                autosave();
            }
        });
        
        console.log('üéâ Initialisation termin√©e !');
    });
})();
</script>

{% endblock %}
