<!-- ðŸ’¾ Template admin personnalisÃ© avec autosave + INDICATEUR PERMANENT -->

{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}

<style>
    /* Indicateur permanent en haut Ã  droite */
    #autosave-indicator {
        position: fixed;
        top: 32px;
        right: 20px;
        padding: 8px 15px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 9999;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #autosave-indicator.saved {
        border-color: #4CAF50;
        background: #f1f8f4;
    }
    
    #autosave-indicator.saving {
        border-color: #FF9800;
        background: #fff8f0;
    }
    
    #autosave-indicator.error {
        border-color: #F44336;
        background: #fef5f5;
    }
    
    /* Message temporaire en bas (pour erreurs) */
    #autosave-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background: #F44336;
        color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: none;
        z-index: 9999;
        font-size: 14px;
    }
</style>

<script>
(function() {
    console.log('ðŸš€ Script autosave chargÃ©');
    
    // Configuration
    const AUTOSAVE_INTERVAL = 5000; // 5 secondes
    
    let autosaveTimer = null;
    let isDirty = false;
    let eleveId = null;
    let CSRF_TOKEN = null;
    let lastSaveTime = null;
    let timeUpdateInterval = null;
    
    // RÃ©cupÃ©rer l'ID de l'Ã©lÃ¨ve depuis l'URL
    const urlParts = window.location.pathname.split('/');
    const changeIndex = urlParts.indexOf('change');
    if (changeIndex > 0 && urlParts[changeIndex - 1]) {
        eleveId = urlParts[changeIndex - 1];
        console.log('ðŸ“‹ ID Ã©lÃ¨ve trouvÃ©:', eleveId);
    } else {
        console.log('ðŸ“‹ Nouvel Ã©lÃ¨ve (pas d\'ID)');
    }
    
    // CrÃ©er l'indicateur permanent
    function createIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'autosave-indicator';
        indicator.innerHTML = '<span class="status-icon">âšª</span><span class="status-text">En attente de saisie</span>';
        document.body.appendChild(indicator);
    }
    
    // Mettre Ã  jour l'indicateur
    function updateIndicator(status, message, icon) {
        const indicator = document.getElementById('autosave-indicator');
        if (!indicator) return;
        
        indicator.className = status;
        indicator.querySelector('.status-icon').textContent = icon;
        indicator.querySelector('.status-text').textContent = message;
    }
    
    // Mettre Ã  jour le temps Ã©coulÃ©
    function updateTimeElapsed() {
        if (!lastSaveTime) return;
        
        const elapsed = Math.floor((Date.now() - lastSaveTime) / 1000);
        let timeText = elapsed < 60 ? `il y a ${elapsed}s` : `il y a ${Math.floor(elapsed / 60)}min`;
        
        updateIndicator('saved', `SauvegardÃ© ${timeText}`, 'ðŸŸ¢');
    }
    
    // Fonction pour afficher le statut (erreurs uniquement)
    function showStatus(message, type) {
        if (type !== 'error') return;
        
        let statusDiv = document.getElementById('autosave-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'autosave-status';
            document.body.appendChild(statusDiv);
        }
        
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        setTimeout(function() {
            statusDiv.style.display = 'none';
        }, 5000);
    }
    
    // Fonction pour collecter les donnÃ©es du formulaire
    function getFormData() {
        const data = {
            id: eleveId,
            nom: document.getElementById('id_nom')?.value || '',
            prenom: document.getElementById('id_prenom')?.value || '',
            telephone: document.getElementById('id_telephone')?.value || '',
            nom_parent: document.getElementById('id_nom_parent')?.value || '',
            prenom_parent: document.getElementById('id_prenom_parent')?.value || '',
            telephone_parent: document.getElementById('id_telephone_parent')?.value || '',
            classe: document.getElementById('id_classe')?.value || '',
            etablissement: document.getElementById('id_etablissement')?.value || '',
            ville: document.getElementById('id_ville')?.value || '',
            code_postal: document.getElementById('id_code_postal')?.value || '',
            numero_rue: document.getElementById('id_numero_rue')?.value || '',
            adresse: document.getElementById('id_adresse')?.value || '',
            arrondissement: document.getElementById('id_arrondissement')?.value || '',
            latitude: document.getElementById('id_latitude')?.value || '',
            longitude: document.getElementById('id_longitude')?.value || '',
            statut: document.getElementById('id_statut')?.value || 'a_accompagner',
            informations_complementaires: document.getElementById('id_informations_complementaires')?.value || '',
        };
        
        return data;
    }
    
    // Fonction de sauvegarde automatique
    async function autosave() {
        if (!isDirty) {
            console.log('â­ï¸  Pas de modifications');
            return;
        }
        
        if (!CSRF_TOKEN) {
            console.error('âŒ Token CSRF non disponible');
            updateIndicator('error', 'Erreur: Token CSRF manquant', 'ðŸ”´');
            return;
        }
        
        updateIndicator('saving', 'Sauvegarde en cours...', 'ðŸŸ¡');
        
        const data = getFormData();
        
        try {
            const response = await fetch('/autosave/eleve/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN,
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (!eleveId && result.id) {
                    eleveId = result.id;
                    const newUrl = window.location.pathname.replace('/add/', '/' + result.id + '/change/');
                    window.history.replaceState({}, '', newUrl);
                }
                
                lastSaveTime = Date.now();
                updateIndicator('saved', 'SauvegardÃ© Ã  l\'instant', 'ðŸŸ¢');
                
                if (timeUpdateInterval) clearInterval(timeUpdateInterval);
                timeUpdateInterval = setInterval(updateTimeElapsed, 1000);
                
                isDirty = false;
                console.log('âœ… Sauvegarde rÃ©ussie !');
            } else {
                console.error('âŒ Erreur:', result.error);
                updateIndicator('error', 'Erreur de sauvegarde', 'ðŸ”´');
                showStatus('âœ— Erreur: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('âŒ Erreur:', error);
            updateIndicator('error', 'Erreur de connexion', 'ðŸ”´');
            showStatus('âœ— Erreur de connexion', 'error');
        }
    }
    
    // Marquer le formulaire comme modifiÃ©
    function markDirty(event) {
        console.log('âœï¸  ModifiÃ©:', event?.target?.id || event?.target?.name);
        
        if (!isDirty) {
            isDirty = true;
            updateIndicator('', 'Modifications non sauvegardÃ©es', 'ðŸŸ¡');
        }
    }
    
    // DÃ©marrer l'autosave
    function startAutosave() {
        console.log('â° DÃ©marrage autosave (5 secondes)');
        setTimeout(autosave, 2000);
        autosaveTimer = setInterval(autosave, AUTOSAVE_INTERVAL);
    }
    
    // ArrÃªter l'autosave
    function stopAutosave() {
        if (autosaveTimer) clearInterval(autosaveTimer);
        if (timeUpdateInterval) clearInterval(timeUpdateInterval);
    }
    
    // Attacher les listeners Ã  un champ
    function attachListeners(field) {
        if (!field) return;
        
        ['input', 'change', 'keyup', 'blur'].forEach(function(eventType) {
            field.addEventListener(eventType, markDirty);
        });
    }
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸ“„ DOM chargÃ©');
        
        createIndicator();
        
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            CSRF_TOKEN = csrfInput.value;
            console.log('âœ… Token CSRF rÃ©cupÃ©rÃ©');
        } else {
            console.error('âŒ Token CSRF introuvable');
            updateIndicator('error', 'Erreur: Token CSRF manquant', 'ðŸ”´');
            showStatus('âœ— Erreur: Token CSRF manquant', 'error');
            return;
        }
        
        console.log('ðŸ‘‚ Attachement listeners...');
        
        const fieldIds = [
            'id_nom', 'id_prenom', 'id_telephone',
            'id_nom_parent', 'id_prenom_parent', 'id_telephone_parent',
            'id_classe', 'id_etablissement', 'id_ville', 'id_code_postal',
            'id_numero_rue', 'id_adresse', 'id_arrondissement',
            'id_latitude', 'id_longitude', 'id_statut',
            'id_informations_complementaires'
        ];
        
        let fieldsFound = 0;
        fieldIds.forEach(function(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                attachListeners(field);
                fieldsFound++;
            }
        });
        
        console.log('âœ… ' + fieldsFound + ' champs trouvÃ©s sur ' + fieldIds.length);
        
        const form = document.querySelector('form');
        if (form) {
            console.log('ðŸ“‹ Formulaire trouvÃ©');
            
            const allInputs = form.querySelectorAll('input, textarea, select');
            console.log('   ' + allInputs.length + ' Ã©lÃ©ments');
            
            allInputs.forEach(function(input) {
                if (input.type !== 'hidden' && input.type !== 'submit' && input.type !== 'button') {
                    ['input', 'change', 'keyup'].forEach(function(eventType) {
                        input.addEventListener(eventType, markDirty);
                    });
                }
            });
            
            console.log('âœ… Listeners globaux attachÃ©s');
            
            form.addEventListener('submit', async function(e) {
                console.log('ðŸ“¤ Soumission formulaire');
                updateIndicator('saving', 'Validation...', 'ðŸŸ¡');
                
                if (eleveId) {
                    try {
                        await fetch('/validate/eleve/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': CSRF_TOKEN,
                            },
                            body: JSON.stringify({ id: eleveId }),
                        });
                        console.log('âœ… Validation envoyÃ©e');
                    } catch (error) {
                        console.error('âŒ Erreur validation:', error);
                    }
                }
            });
        } else {
            console.error('âŒ Formulaire non trouvÃ© !');
        }
        
        startAutosave();
        
        window.addEventListener('beforeunload', function() {
            stopAutosave();
            if (isDirty) autosave();
        });
        
        console.log('ðŸŽ‰ Initialisation terminÃ©e !');
    });
})();
</script>

{% endblock %}
